<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- Add icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"/>
    <script
            src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        function deleteBook(id) {
            $.ajax({
                url:"dashboard/"+id,
                method:"DELETE",
                cache: false,
                success: function (result) {
                    if (result.status == "success") {
                        var book=result.data
                        $("#postResultDiv").html(
                            "DELETE " + book.id+" "+ book.author+" "+book.title+" "+book.year+ " <br></p>");
                    } else {
                        $("#postResultDiv").html("<strong>Error</strong>");
                    }
                    ajaxGetAllBooks();
                },
                error: function (error) {
                    $("#postResultDiv").html("<strong>DELETE Error - function only for ADMIN</strong>");
                }

            });
        }
        //for tests
        function getclick() {
            alert("Hello! I am an alert box!!");
        }
        // DO POST
        function ajaxPost() {
            // PREPARE FORM DATA
            var formData = {
                year: $("#year").val(),
                title: $("#title").val(),
                author: $("#author").val()
            }
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "saveBook",
                data: JSON.stringify(formData),
                dataType: 'json',
                success: function (result) {
                    if (result.status == "success") {
                        var book=result.data
                        $("#postResultDiv").html(
                            "New Book: { " + book.id+","+ book.author+","+book.title+","+book.year+ "} <br></p>");
                    } else {
                        $("#postResultDiv").html("<strong>"+result.status+"</strong>");
                    }
                    console.log(result);
                    ajaxGetAllBooks();
                },
                error: function (e) {
                    $("#postResultDiv").html("<strong>Error - function only for ADMIN</strong>");
                    console.log("ERROR: ", e);
                }
            });
        }
        // DO GET all books
        function ajaxGetAllBooks() {
            $.ajax({
                type: "GET",
                url: "getBooks",
                success: function (result) {
                    if (result.status == "success") {
                        $('#getResultDiv ul').empty();
                        var tableBody = $('#tbody');
                        tableBody.empty();
                        $(result.data).each(function (index, element) {
                            tableBody.append('<tr>' +
                                '<td>'+element.id+'</td>' +
                                '<td>'+element.title+'</td>' +
                                '<td>'+element.author+'</td>' +
                                '<td>'+element.year+'</td>' +
                                '<td>' +
                                    '<button class=\"btn btn-danger remove\"onclick = "deleteBook('+element.id+')">' +
                                    '<i class=\"fa fa-trash\"></i>' +
                                    '</button>' +
                                '</td></tr>');
                        });
                        console.log("Success: ", result);
                    } else {
                        $("#getResultDiv").html("<strong>Error</strong>");
                        console.log("Fail: ", result);
                    }
                },
                error: function (e) {
                    $("#getResultDiv").html("<strong>Error</strong>");
                    console.log("ERROR: ", e);
                }
            });
        }

        function getBookById() {
            var bookId = $("#idSearchBook").val();
            $.ajax({
                url:"dashboard/"+bookId,
                method:"GET",
                cache: false,
                success: function (result) {
                    if (result.status == "success") {
                        var book=result.data
                        $("#searchBookResultDiv").html(
                            "Search Book: "+ book.id+" "+ book.author+" "+book.title+" "+book.year+ " <br></p>");
                    } else {
                        $("#searchBookResultDiv").html("<strong>Error</strong>");
                    }
                },
                error: function (error) {
                    $("#searchBookResultDiv").html("<strong>SEARCH Error</strong>");
                }

            });
        }

        $(document).ready(
            function () {
                // GET ALL BOOKS REQUEST
                    ajaxGetAllBooks();

                // ADD BOOK SUBMIT FORM
                $("#bookForm").submit(function (event) {
                    // Prevent the form from submitting via the browser.
                    event.preventDefault();
                    ajaxPost();
                });
                // GET BOOK BY ID
                $("#searchBook").submit(function (event) {
                    // Prevent the form from submitting via the browser.
                    event.preventDefault();
                    getBookById();
                });


            });
    </script>
    <title>Dashboard</title>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="collapse navbar-collapse" id="myNavbar">
        <a href="/logout" class="btn btn-outline-secondary">Log out</a>
    </div>
</nav>
<h1 style="text-align: center">Dashboard</h1>
<div class="container">
    <div class="row">
        <div class="col">
            <div class="container">
                <div id="getResultDivForTable">
                    <table class="table table-sm table-striped">
                        <thead id="tthead">
                        <tr>
                            <th scope="col">Id</th>
                            <th scope="col">Title</th>
                            <th scope="col">Author</th>
                            <th scope="col">Year</th>
                            <th scope="col"></th>
                        </tr>
                        </thead>
                        <tbody id="tbody">
                        </tbody>
                    </table>
                </div>
                <div id="getResultDiv"></div>
            </div>
        </div>
        <div class="col">
            <div class="container">
                <form class="row g-3 needs-validation" action="/dashboard" id="bookForm">
                    <div class="col-md-4">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" name="title" class="form-control" id="title" value="Title" required>
                    </div>
                    <div class="col-md-4">
                        <label for="author" class="form-label">Author</label>
                        <input type="text" name="author" class="form-control" id="author" value="Author" required>
                    </div>
                    <div class="col-md-4">
                        <label for="year" class="form-label">Year</label>
                        <input type="number" name="year" class="form-control" id="year" value="1900" required>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary " type="submit">Add</button>
                    </div>
                </form>
                <div id="postResultDiv"></div>
            </div>
            <div class="container">
                <br><br>
                <div>
                    Search book by id:
                </div>
                <form class="row g-3 needs-validation" action="/dashboard" id="searchBook">
                    <div class="col-md-4">
                        <label for="idSearchBook" class="form-label">Book id</label>
                        <input type="text" name="idSearchBook" class="form-control" id="idSearchBook" value="id" required>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary " type="submit">Search</button>
                    </div>
                </form>
                <div id="searchBookResultDiv"></div>
            </div>
        </div>

    </div>
</div>


<div class="container">


</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js"
        integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc"
        crossorigin="anonymous"></script>

</body>
</html>